#!/usr/bin/env ruby

require 'kpeg'
require 'kpeg/code_generator'
require 'kpeg/format_parser'
require 'kpeg/grammar_renderer'

require 'optparse'

options = {}
OptionParser.new do |o|
  o.banner = "Usage: kpeg [options]"

  o.on("-t", "--test", "Syntax check the file only") do |v|
    options[:test] = v
  end

  o.on("-o", "--output FILE", "Where to output the parser") do |v|
    options[:output] = v
  end

  o.on("-n", "--name NAME", "Class name to use for the parser") do |v|
    options[:name] = v
  end

  o.on("-f", "--force", "Overwrite the output if it exists") do |v|
    options[:force] = v
  end

  o.on("-s", "--stand-alone", "Write the parser to run standalone") do |v|
    options[:standalone] = v
  end

  o.on("-v", "--[no-]verbose", "Run verbosely") do |v|
    options[:verbose] = v
  end

  o.on("-d", "--debug", "Debug parsing the file") do |v|
    options[:debug] = v
  end
end.parse!

if !options[:test] and !options[:name]
  puts "Please specify -n"
  exit 1
end

name = options[:name]

file = ARGV.shift

if options[:output]
  new_path = options[:output]
else
  new_path = "#{file}.rb"
end

if !options[:test] and File.exists?(new_path) and !options[:force]
  puts "Path #{new_path} already exists, not overwriting\n"
  exit 1
end

if options[:debug]
  parser = KPeg::Parser.new File.read(file), KPeg::FORMAT, true
else
  parser = KPeg::FormatParser.new File.read(file), true
end

unless m = parser.parse
  puts "Syntax error in grammar #{file}"
  parser.show_error
  exit 1
end

if options[:debug]
  grammar = KPeg::Grammar.new
  m.value(grammar)
else
  grammar = parser.grammar
end

if options[:test]
  puts "Syntax ok"

  if options[:debug]
    gr = KPeg::GrammarRenderer.new(grammar)
    gr.render(STDOUT)
  end
  exit 0
end


cg = KPeg::CodeGenerator.new name, grammar
cg.standalone = options[:standalone]

File.open new_path, "w" do |f|
  f << cg.output
end

puts "Wrote #{new_path}"
